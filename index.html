<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AB测试置信分析工具v1.2</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- 配置Tailwind -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#165DFF',
            secondary: '#36CFC9',
            success: '#52C41A',
            warning: '#FAAD14',
            danger: '#FF4D4F',
            neutral: {
              100: '#F5F7FA',
              200: '#E5E6EB',
              300: '#C9CDD4',
              400: '#86909C',
              500: '#4E5969',
              600: '#272E3B',
              700: '#1D2129',
            }
          },
          fontFamily: {
            inter: ['Inter', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 2px 14px 0 rgba(0, 0, 0, 0.06)',
            'hover': '0 6px 20px 0 rgba(0, 0, 0, 0.1)',
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .transition-smooth {
        transition: all 0.3s ease;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #165DFF 0%, #0E42D2 100%);
      }
      .text-balance {
        text-wrap: balance;
      }
    }
  </style>
</head>

<body class="font-inter bg-neutral-100 text-neutral-700 min-h-screen">
  <!-- 顶部导航 -->
  <header class="gradient-bg text-white shadow-md">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-bar-chart text-2xl"></i>
        <h1 class="text-xl md:text-2xl font-bold">AB测试置信分析工具</h1>
      </div>
      <div class="hidden md:flex items-center space-x-6">
        <a href="#" class="hover:text-neutral-100 transition-smooth"><i class="fa fa-question-circle mr-1"></i>帮助</a>
        <a href="#" class="hover:text-neutral-100 transition-smooth"><i class="fa fa-history mr-1"></i>历史</a>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8">
    <!-- 数据上传区域 -->
    <section id="upload-section" class="mb-10 bg-white rounded-xl shadow-card p-6 md:p-8 transition-smooth hover:shadow-hover">
      <h2 class="text-xl md:text-2xl font-semibold mb-6 text-neutral-700">数据上传</h2>
      
      <!-- 格式要求提示 -->
      <div class="bg-neutral-100 rounded-lg p-4 mb-6">
        <p class="text-neutral-600 mb-2"><i class="fa fa-info-circle text-primary mr-2"></i>CSV文件格式要求：</p>
        <ul class="list-disc pl-5 space-y-1 text-neutral-600">
          <li><span class="font-medium">第一行必须为表头</span></li>
          <li><span class="text-danger font-medium">分组标识列的表头必须为"分组列"</span></li>
          <li><span class="text-danger font-medium">时间维度列的表头必须为"时间"</span></li>
          <li>其他列将作为分析指标</li>
        </ul>
      </div>
      
      <!-- 状态提示区域 -->
      <div id="status-message" class="mb-6 hidden"></div>
      
      <!-- 上传区域 -->
      <div id="drop-area" class="border-2 border-dashed border-neutral-300 rounded-lg p-8 text-center transition-smooth hover:border-primary cursor-pointer">
        <i class="fa fa-cloud-upload text-4xl text-neutral-400 mb-4"></i>
        <p class="text-neutral-600 mb-2">拖放CSV文件到此处，或</p>
        <label class="inline-block bg-primary text-white px-6 py-2 rounded-lg font-medium cursor-pointer hover:bg-primary/90 transition-smooth">
          <i class="fa fa-file-text-o mr-2"></i>选择文件
          <input type="file" id="file-input" accept=".csv" class="hidden">
        </label>
        <p id="file-name" class="mt-4 text-neutral-500 hidden"></p>
      </div>
      
      <!-- 数据预览 -->
      <div id="data-preview" class="mt-6 hidden">
        <h3 class="text-lg font-medium mb-3 text-neutral-700">数据预览</h3>
        <div class="overflow-x-auto max-h-60 border border-neutral-200 rounded-lg">
          <table class="min-w-full bg-white">
            <thead>
              <tr id="preview-header" class="bg-neutral-100 text-neutral-600"></tr>
            </thead>
            <tbody id="preview-body"></tbody>
          </table>
        </div>
      </div>
      
      <!-- 对照组选择 -->
      <div id="control-group-selection" class="mt-6 hidden">
        <h3 class="text-lg font-medium mb-3 text-neutral-700">选择对照组（可多选，剩余为测试组）</h3>
        <div id="control-group-checkboxes" class="flex flex-wrap gap-3 mb-4"></div>
      </div>
      
      <!-- 核心指标选择 -->
      <div id="metrics-selection" class="mt-6 hidden">
        <h3 class="text-lg font-medium mb-3 text-neutral-700">选择核心指标（可多选）</h3>
        <div id="metrics-checkboxes" class="flex flex-wrap gap-3 mb-4"></div>
      </div>
      
      <!-- 分析按钮 -->
      <div class="mt-8 text-center">
        <button id="analyze-btn" class="bg-primary text-white px-8 py-3 rounded-lg font-medium text-lg shadow-md hover:bg-primary/90 transition-smooth disabled:opacity-50 disabled:cursor-not-allowed" disabled>
          <i class="fa fa-play-circle mr-2"></i>开始AB测试分析
        </button>
      </div>
    </section>
    
    <!-- 分析结果区域 -->
    <section id="results-section" class="hidden mb-10">
      <!-- 业务建议 -->
      <div id="business-insights" class="bg-white rounded-xl shadow-card p-6 md:p-8 mb-8 transition-smooth hover:shadow-hover">
        <h2 class="text-xl md:text-2xl font-semibold mb-6 text-neutral-700">
          <i class="fa fa-lightbulb-o text-warning mr-2"></i>业务建议
        </h2>
        <div id="insights-content" class="prose max-w-none"></div>
      </div>
      
      <!-- 核心指标结果 -->
      <div id="key-metrics-results" class="mb-8">
        <h2 class="text-xl md:text-2xl font-semibold mb-6 text-neutral-700">
          <i class="fa fa-star text-warning mr-2"></i>核心指标置信分析结果
        </h2>
        <div id="key-metrics-charts" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
      </div>
      
      <!-- 所有指标结果 -->
      <div id="all-metrics-results">
        <h2 class="text-xl md:text-2xl font-semibold mb-6 text-neutral-700">
          <i class="fa fa-bar-chart text-primary mr-2"></i>所有指标置信分析结果
        </h2>
        <div id="all-metrics-charts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
      </div>
    </section>
    
    <!-- 加载状态 -->
    <div id="loading-indicator" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
      <div class="bg-white p-8 rounded-xl shadow-lg text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-4"></div>
        <p class="text-lg font-medium text-neutral-700">正在进行AB测试分析，请稍候...</p>
      </div>
    </div>
  </main>

  <footer class="bg-neutral-700 text-white py-6">
    <div class="container mx-auto px-4 text-center">
      <p>© 2023 AB测试置信分析工具 | 专业的数据分析解决方案</p>
      <div class="mt-3 flex justify-center space-x-4">
        <a href="#" class="hover:text-primary transition-smooth"><i class="fa fa-github text-xl"></i></a>
        <a href="#" class="hover:text-primary transition-smooth"><i class="fa fa-twitter text-xl"></i></a>
        <a href="#" class="hover:text-primary transition-smooth"><i class="fa fa-linkedin text-xl"></i></a>
      </div>
    </div>
  </footer>

  <script>
    // 全局变量存储解析后的数据
    let parsedData = null;
    let metrics = [];
    let groups = [];
    let selectedControlGroups = [];
    let selectedKeyMetrics = [];
    
    // DOM元素
    const dropArea = document.getElementById('drop-area');
    const fileInput = document.getElementById('file-input');
    const fileName = document.getElementById('file-name');
    const dataPreview = document.getElementById('data-preview');
    const previewHeader = document.getElementById('preview-header');
    const previewBody = document.getElementById('preview-body');
    const controlGroupSelection = document.getElementById('control-group-selection');
    const controlGroupCheckboxes = document.getElementById('control-group-checkboxes');
    const metricsSelection = document.getElementById('metrics-selection');
    const metricsCheckboxes = document.getElementById('metrics-checkboxes');
    const analyzeBtn = document.getElementById('analyze-btn');
    const resultsSection = document.getElementById('results-section');
    const loadingIndicator = document.getElementById('loading-indicator');
    const businessInsights = document.getElementById('business-insights');
    const insightsContent = document.getElementById('insights-content');
    const keyMetricsCharts = document.getElementById('key-metrics-charts');
    const allMetricsCharts = document.getElementById('all-metrics-charts');
    const statusMessage = document.getElementById('status-message');
    
    // 显示状态消息
    function showStatusMessage(message, type = 'info') {
      statusMessage.textContent = message;
      statusMessage.className = 'mb-6 p-3 rounded-lg';
      
      switch(type) {
        case 'success':
          statusMessage.classList.add('bg-success/10', 'text-success', 'border', 'border-success/30');
          statusMessage.innerHTML = `<i class="fa fa-check-circle mr-2"></i>${message}`;
          break;
        case 'error':
          statusMessage.classList.add('bg-danger/10', 'text-danger', 'border', 'border-danger/30');
          statusMessage.innerHTML = `<i class="fa fa-exclamation-circle mr-2"></i>${message}`;
          break;
        case 'warning':
          statusMessage.classList.add('bg-warning/10', 'text-warning', 'border', 'border-warning/30');
          statusMessage.innerHTML = `<i class="fa fa-exclamation-triangle mr-2"></i>${message}`;
          break;
        default:
          statusMessage.classList.add('bg-primary/10', 'text-primary', 'border', 'border-primary/30');
          statusMessage.innerHTML = `<i class="fa fa-info-circle mr-2"></i>${message}`;
      }
      
      statusMessage.classList.remove('hidden');
    }
    
    function hideStatusMessage() {
      statusMessage.classList.add('hidden');
      statusMessage.innerHTML = '';
    }
    
    // 拖放事件处理
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false);
    });
    
    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false);
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, unhighlight, false);
    });
    
    function highlight() {
      dropArea.classList.add('border-primary');
      dropArea.classList.add('bg-primary/5');
    }
    
    function unhighlight() {
      dropArea.classList.remove('border-primary');
      dropArea.classList.remove('bg-primary/5');
    }
    
    // 处理文件上传
    dropArea.addEventListener('drop', handleDrop, false);
    fileInput.addEventListener('change', handleFiles, false);
    
    function handleDrop(e) {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles({ target: { files } });
    }
    
    function handleFiles(e) {
      const file = e.target.files[0];
      if (file) {
        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
          showStatusMessage('请上传CSV格式的文件', 'error');
          return;
        }
        
        fileName.textContent = `已选择: ${file.name}`;
        fileName.classList.remove('hidden');
        
        const reader = new FileReader();
        reader.onload = function(e) {
          parseCSV(e.target.result);
        };
        reader.readAsText(file);
      }
    }
    
    // 解析CSV数据
    function parseCSV(csvText) {
      // 清除之前的数据和状态
      previewHeader.innerHTML = '';
      previewBody.innerHTML = '';
      controlGroupCheckboxes.innerHTML = '';
      metricsCheckboxes.innerHTML = '';
      selectedControlGroups = [];
      selectedKeyMetrics = [];
      groups = [];
      dataPreview.classList.add('hidden');
      controlGroupSelection.classList.add('hidden');
      metricsSelection.classList.add('hidden');
      analyzeBtn.disabled = true;
      hideStatusMessage();
      
      // 分割行（处理可能的空行）
      const lines = csvText.split('\n')
        .map(line => line.trim())
        .filter(line => line !== '');
      
      // 检查是否有表头和数据行
      if (lines.length < 1) {
        showStatusMessage('CSV文件为空，请检查文件内容', 'error');
        return;
      }
      
      // 第一行必须为表头
      const headers = lines[0].split(',').map(header => header.trim());
      
      // 检查是否有数据行
      if (lines.length < 2) {
        showStatusMessage('CSV文件只有表头，没有数据行，请检查文件内容', 'error');
        return;
      }
      
      // 检查必要的列
      const missingColumns = [];
      if (!headers.includes('分组列')) {
        missingColumns.push('分组列');
      }
      
      if (!headers.includes('时间')) {
        missingColumns.push('时间');
      }
      
      if (missingColumns.length > 0) {
        showStatusMessage(`CSV文件表头中缺少必要的列：${missingColumns.join('、')}，请检查表头是否正确`, 'error');
        return;
      }
      
      // 提取指标（排除分组列和时间列）
      metrics = headers.filter(header => header !== '分组列' && header !== '时间');
      
      if (metrics.length === 0) {
        showStatusMessage('未找到可分析的指标列，请确保CSV文件包含除"分组列"和"时间"之外的其他数据列', 'error');
        return;
      }
      
      // 解析数据行
      parsedData = [];
      let invalidRows = 0;
      const groupSet = new Set();
      
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',');
        const row = {};
        let rowValid = true;
        
        headers.forEach((header, index) => {
          let value = values[index] ? values[index].trim() : '';
          
          // 分组列和时间列保留原始值
          if (header === '分组列' || header === '时间') {
            row[header] = value;
            if (value === '') rowValid = false;
            if (header === '分组列' && value !== '') groupSet.add(value);
            return;
          }
          
          // 处理其他指标列
          if (value === '') {
            row[header] = null;
            return;
          }
          
          // 处理百分比数据
          if (value.includes('%')) {
            const numValue = parseFloat(value.replace('%', '')) / 100;
            if (!isNaN(numValue)) {
              row[header] = numValue;
            } else {
              row[header] = null;
              rowValid = false;
            }
          } 
          // 尝试转换为数字
          else if (!isNaN(value)) {
            row[header] = parseFloat(value);
          } else {
            row[header] = null;
            rowValid = false;
          }
        });
        
        if (rowValid) {
          parsedData.push(row);
        } else {
          invalidRows++;
        }
      }
      
      // 检查是否有有效数据行
      if (parsedData.length === 0) {
        showStatusMessage('未找到有效的数据行，请检查数据格式是否正确', 'error');
        return;
      }
      
      // 检查分组数量
      groups = Array.from(groupSet);
      if (groups.length < 2) {
        showStatusMessage('数据中分组不足，至少需要两个分组进行AB测试分析', 'error');
        return;
      }
      
      // 显示数据解析成功消息
      let successMsg = `数据解析成功！共解析 ${parsedData.length} 行有效数据，包含 ${groups.length} 个分组`;
      if (invalidRows > 0) {
        successMsg += `，跳过 ${invalidRows} 行无效数据`;
      }
      showStatusMessage(successMsg, 'success');
      
      // 显示数据预览
      displayDataPreview(headers, parsedData);
      
      // 显示对照组选择
      displayControlGroupSelection(groups);
      
      // 显示指标选择
      displayMetricsSelection(metrics);
      
      // 初始禁用分析按钮，等待选择对照组和核心指标
      analyzeBtn.disabled = true;
    }
    
    // 显示数据预览
    function displayDataPreview(headers, data) {
      // 创建表头
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        th.className = 'px-4 py-2 border-b text-left';
        if (header === '分组列' || header === '时间') {
          th.className += ' text-danger font-medium';
        }
        previewHeader.appendChild(th);
      });
      
      // 创建预览行（最多显示5行）
      const rowsToShow = Math.min(5, data.length);
      for (let i = 0; i < rowsToShow; i++) {
        const tr = document.createElement('tr');
        tr.className = i % 2 === 0 ? 'bg-white' : 'bg-neutral-50';
        
        headers.forEach(header => {
          const td = document.createElement('td');
          td.className = 'px-4 py-2 border-b';
          
          // 格式化显示
          let value = data[i][header];
          if (value === null) {
            td.textContent = 'N/A';
            td.className += ' text-neutral-400';
          } else if (typeof value === 'number') {
            // 如果是小数且接近百分比，显示为百分比
            if (value >= 0 && value <= 1) {
              td.textContent = (value * 100).toFixed(2) + '%';
            } else {
              td.textContent = value.toLocaleString(undefined, {
                maximumFractionDigits: 2
              });
            }
          } else {
            td.textContent = value;
          }
          
          tr.appendChild(td);
        });
        
        previewBody.appendChild(tr);
      }
      
      // 如果有更多数据，显示省略行
      if (data.length > 5) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = headers.length;
        td.className = 'px-4 py-2 border-b text-center text-neutral-500';
        td.textContent = `... 还有 ${data.length - 5} 行数据未显示`;
        tr.appendChild(td);
        previewBody.appendChild(tr);
      }
      
      dataPreview.classList.remove('hidden');
    }
    
    // 显示对照组选择
    function displayControlGroupSelection(groups) {
      controlGroupCheckboxes.innerHTML = '';
      
      groups.forEach(group => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `group-${group}`;
        checkbox.value = group;
        checkbox.className = 'w-4 h-4 text-primary border-neutral-300 rounded focus:ring-primary';
        
        const label = document.createElement('label');
        label.htmlFor = `group-${group}`;
        label.className = 'ml-2 text-neutral-700';
        label.textContent = group;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        controlGroupCheckboxes.appendChild(div);
        
        // 添加事件监听
        checkbox.addEventListener('change', function() {
          updateControlGroups();
        });
      });
      
      controlGroupSelection.classList.remove('hidden');
    }
    
    // 更新对照组选择
    function updateControlGroups() {
      const checkboxes = controlGroupCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
      selectedControlGroups = Array.from(checkboxes).map(cb => cb.value);
      
      // 确保至少选择一个对照组，且测试组至少有一个
      const testGroupsCount = groups.length - selectedControlGroups.length;
      const metricsSelected = selectedKeyMetrics.length > 0;
      
      analyzeBtn.disabled = !(selectedControlGroups.length > 0 && testGroupsCount > 0 && metricsSelected);
      
      if (selectedControlGroups.length === 0) {
        showStatusMessage('请至少选择一个对照组', 'warning');
      } else if (testGroupsCount === 0) {
        showStatusMessage('请保留至少一个测试组（不要选择所有分组作为对照组）', 'warning');
      } else if (!metricsSelected) {
        showStatusMessage('请至少选择一个核心指标', 'warning');
      } else {
        hideStatusMessage();
      }
    }
    
    // 显示指标选择
    function displayMetricsSelection(metrics) {
      metricsCheckboxes.innerHTML = '';
      
      metrics.forEach(metric => {
        const div = document.createElement('div');
        div.className = 'flex items-center';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `metric-${metric}`;
        checkbox.value = metric;
        checkbox.className = 'w-4 h-4 text-primary border-neutral-300 rounded focus:ring-primary';
        
        const label = document.createElement('label');
        label.htmlFor = `metric-${metric}`;
        label.className = 'ml-2 text-neutral-700';
        label.textContent = metric;
        
        div.appendChild(checkbox);
        div.appendChild(label);
        metricsCheckboxes.appendChild(div);
        
        // 添加事件监听
        checkbox.addEventListener('change', function() {
          if (this.checked) {
            selectedKeyMetrics.push(metric);
          } else {
            selectedKeyMetrics = selectedKeyMetrics.filter(m => m !== metric);
          }
          
          updateControlGroups(); // 触发按钮状态更新
        });
      });
      
      metricsSelection.classList.remove('hidden');
    }
    
    // 分析按钮点击事件
    analyzeBtn.addEventListener('click', function() {
      // 显示加载状态
      loadingIndicator.classList.remove('hidden');
      
      // 模拟分析过程
      setTimeout(() => {
        performAnalysis();
        loadingIndicator.classList.add('hidden');
        resultsSection.classList.remove('hidden');
        // 滚动到结果区域
        resultsSection.scrollIntoView({ behavior: 'smooth' });
      }, 1500);
    });
    
    // 执行AB测试分析
    function performAnalysis() {
      // 清空之前的结果
      insightsContent.innerHTML = '';
      keyMetricsCharts.innerHTML = '';
      allMetricsCharts.innerHTML = '';
      
      // 确定测试组（未被选为对照组的分组）
      const testGroups = groups.filter(group => !selectedControlGroups.includes(group));
      
      // 按分组聚合数据
      const groupData = {};
      parsedData.forEach(row => {
        const group = row['分组列'];
        if (!groupData[group]) {
          groupData[group] = {
            count: 0,
            metrics: {}
          };
          metrics.forEach(metric => {
            groupData[group].metrics[metric] = [];
          });
        }
        
        groupData[group].count++;
        metrics.forEach(metric => {
          if (typeof row[metric] === 'number') {
            groupData[group].metrics[metric].push(row[metric]);
          }
        });
      });
      
      // 合并对照组数据
      const combinedControlData = {
        count: 0,
        metrics: {}
      };
      metrics.forEach(metric => {
        combinedControlData.metrics[metric] = [];
      });
      
      selectedControlGroups.forEach(controlGroup => {
        combinedControlData.count += groupData[controlGroup].count;
        metrics.forEach(metric => {
          combinedControlData.metrics[metric] = [
            ...combinedControlData.metrics[metric],
            ...groupData[controlGroup].metrics[metric]
          ];
        });
      });
      
      // 计算每个指标的统计数据
      const analysisResults = {};
      metrics.forEach(metric => {
        analysisResults[metric] = {
          control: {
            name: selectedControlGroups.length > 1 ? '合并对照组' : selectedControlGroups[0],
            ...calculateGroupStats(combinedControlData.metrics[metric])
          },
          tests: {}
        };
        
        // 计算每个测试组的统计数据和与对照组的差异
        testGroups.forEach(testGroup => {
          const testStats = calculateGroupStats(groupData[testGroup].metrics[metric]);
          analysisResults[metric].tests[testGroup] = {
            ...testStats,
            difference: calculateDifference(analysisResults[metric].control, testStats)
          };
        });
      });
      
      // 生成业务建议
      generateBusinessInsights(analysisResults, selectedKeyMetrics, testGroups, 
        selectedControlGroups.length > 1 ? '合并对照组' : selectedControlGroups[0]);
      
      // 生成核心指标图表
      selectedKeyMetrics.forEach(metric => {
        createMetricChart(metric, analysisResults[metric], keyMetricsCharts, true);
      });
      
      // 生成所有指标图表
      metrics.forEach(metric => {
        if (!selectedKeyMetrics.includes(metric)) {
          createMetricChart(metric, analysisResults[metric], allMetricsCharts, false);
        }
      });
    }
    
    // 计算分组统计数据
    function calculateGroupStats(values) {
      const mean = calculateMean(values);
      const std = calculateStandardDeviation(values);
      const n = values.length;
      
      return {
        mean,
        std,
        n,
        // 计算95%置信区间
        ciLower: mean - 1.96 * (std / Math.sqrt(n)),
        ciUpper: mean + 1.96 * (std / Math.sqrt(n))
      };
    }
    
    // 计算与对照组的差异
    function calculateDifference(control, test) {
      const diff = test.mean - control.mean;
      const relativeDiff = (diff / control.mean) * 100;
      const pValue = simulatePValue(control, test);
      
      return {
        absolute: diff,
        relative: relativeDiff,
        significant: pValue < 0.05,
        pValue: pValue
      };
    }
    
    // 生成业务建议
    function generateBusinessInsights(results, keyMetrics, testGroups, controlName) {
      let insights = `<p>根据AB测试分析结果，以${controlName}为基准，对比分析以下测试组：${testGroups.join('、')}，得出以下业务建议：</p>`;
      
      // 按测试组分析核心指标
      testGroups.forEach(testGroup => {
        insights += `<h4 class="font-medium text-lg mt-4 mb-2">与${testGroup}的对比分析：</h4>`;
        insights += '<ul class="list-disc pl-5 my-2">';
        
        keyMetrics.forEach(metric => {
          const result = results[metric].tests[testGroup];
          const diff = result.difference;
          
          if (diff.significant) {
            if (diff.relative > 0) {
              insights += `<li class="mb-2"><span class="font-medium text-success">${metric}</span>在${testGroup}表现显著优于${controlName}，提升了${Math.abs(diff.relative).toFixed(2)}%，建议考虑推广${testGroup}方案。</li>`;
            } else {
              insights += `<li class="mb-2"><span class="font-medium text-danger">${metric}</span>在${testGroup}表现显著劣于${controlName}，下降了${Math.abs(diff.relative).toFixed(2)}%，不建议推广${testGroup}方案。</li>`;
            }
          } else {
            insights += `<li class="mb-2"><span class="font-medium text-neutral-500">${metric}</span>在${testGroup}与${controlName}间差异不显著（p=${diff.pValue.toFixed(3)}），建议延长测试时间或增加样本量。</li>`;
          }
        });
        
        insights += '</ul>';
      });
      
      // 整体结论
      insights += '<div class="mt-4">';
      
      testGroups.forEach(testGroup => {
        const significantImprovements = keyMetrics.filter(metric => 
          results[metric].tests[testGroup].difference.significant && 
          results[metric].tests[testGroup].difference.relative > 0
        );
        
        const significantDeclines = keyMetrics.filter(metric => 
          results[metric].tests[testGroup].difference.significant && 
          results[metric].tests[testGroup].difference.relative < 0
        );
        
        if (significantImprovements.length > significantDeclines.length) {
          insights += `<p class="p-3 bg-success/10 border border-success/30 rounded-lg text-success my-2"><i class="fa fa-check-circle mr-2"></i>整体来看，${testGroup}在关键指标上表现优于${controlName}，建议考虑推广。</p>`;
        } else if (significantDeclines.length > 0) {
          insights += `<p class="p-3 bg-danger/10 border border-danger/30 rounded-lg text-danger my-2"><i class="fa fa-exclamation-circle mr-2"></i>整体来看，${testGroup}在关键指标上表现劣于${controlName}，不建议推广。</p>`;
        } else {
          insights += `<p class="p-3 bg-neutral-100 border border-neutral-300 rounded-lg text-neutral-600 my-2"><i class="fa fa-info-circle mr-2"></i>${testGroup}与${controlName}的测试结果尚未明确，建议继续观察。</p>`;
        }
      });
      
      insights += '</div>';
      
      insightsContent.innerHTML = insights;
    }
    
    // 创建指标图表
    function createMetricChart(metric, result, container, isKeyMetric) {
      const control = result.control;
      const testGroups = Object.keys(result.tests);
      
      // 创建卡片容器
      const card = document.createElement('div');
      card.className = `bg-white rounded-xl shadow-card p-5 transition-smooth hover:shadow-hover ${isKeyMetric ? 'border-l-4 border-primary' : ''}`;
      
      // 标题
      const title = document.createElement('h3');
      title.className = `text-lg font-semibold mb-4 ${isKeyMetric ? 'text-primary' : 'text-neutral-700'}`;
      title.textContent = metric;
      card.appendChild(title);
      
      // 图表容器
      const chartContainer = document.createElement('div');
      chartContainer.className = 'h-64 mb-4';
      const canvas = document.createElement('canvas');
      chartContainer.appendChild(canvas);
      card.appendChild(chartContainer);
      
      // 统计信息
      const statsDiv = document.createElement('div');
      statsDiv.className = 'space-y-2 text-sm mb-3';
      
      // 对照组信息
      const controlDiv = document.createElement('div');
      controlDiv.className = 'bg-neutral-50 p-2 rounded';
      controlDiv.innerHTML = `
        <p class="text-neutral-500">${control.name}均值</p>
        <p class="font-medium">${formatValue(control.mean)}</p>
      `;
      statsDiv.appendChild(controlDiv);
      
      // 测试组信息
      testGroups.forEach(testGroup => {
        const testDiv = document.createElement('div');
        const diff = result.tests[testGroup].difference;
        testDiv.className = `p-2 rounded ${
          diff.significant 
            ? (diff.relative > 0 ? 'bg-success/5 border border-success/20' : 'bg-danger/5 border border-danger/20') 
            : 'bg-neutral-50'
        }`;
        
        testDiv.innerHTML = `
          <p class="text-neutral-500">${testGroup}均值 (与${control.name}相比)</p>
          <p class="font-medium">${formatValue(result.tests[testGroup].mean)} 
            <span class="${diff.relative > 0 ? 'text-success' : 'text-danger'}">
              ${diff.relative > 0 ? '+' : ''}${diff.relative.toFixed(2)}%
              ${diff.significant ? '<span class="text-xs font-normal">(*显著)</span>' : ''}
            </span>
          </p>
        `;
        statsDiv.appendChild(testDiv);
      });
      
      card.appendChild(statsDiv);
      
      container.appendChild(card);
      
      // 绘制图表
      new Chart(canvas, {
        type: 'bar',
        data: {
          labels: [control.name, ...testGroups],
          datasets: [{
            label: '均值',
            data: [control.mean, ...testGroups.map(g => result.tests[g].mean)],
            backgroundColor: [
              'rgba(156, 163, 175, 0.7)',
              ...testGroups.map((_, i) => `rgba(22, 93, 255, ${0.7 - (i * 0.1 > 0.4 ? 0.4 : i * 0.1)})`)
            ],
            borderColor: [
              'rgb(156, 163, 175)',
              ...testGroups.map((_, i) => `rgb(22, 93, 255, ${1 - (i * 0.1 > 0.4 ? 0.4 : i * 0.1)})`)
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  // 如果是比例数据，显示为百分比
                  if (this.chart.data.datasets[0].data.some(v => v >= 0 && v <= 1)) {
                    return (value * 100).toFixed(0) + '%';
                  }
                  return value.toLocaleString(undefined, { maximumFractionDigits: 1 });
                }
              }
            }
          },
          plugins: {
            tooltip: {
              callbacks: {
                label: function(context) {
                  let value = context.raw;
                  const label = context.label;
                  
                  // 计算与对照组的差异（如果是测试组）
                  if (testGroups.includes(label)) {
                    const diff = result.tests[label].difference;
                    return [
                      `均值: ${formatValue(value)}`,
                      `与${control.name}差异: ${diff.relative > 0 ? '+' : ''}${diff.relative.toFixed(2)}%`,
                      `p值: ${diff.pValue.toFixed(3)}`
                    ];
                  }
                  
                  return `均值: ${formatValue(value)}`;
                }
              }
            }
          }
        }
      });
    }
    
    // 工具函数：计算均值
    function calculateMean(values) {
      if (values.length === 0) return 0;
      const sum = values.reduce((acc, val) => acc + val, 0);
      return sum / values.length;
    }
    
    // 工具函数：计算标准差
    function calculateStandardDeviation(values) {
      if (values.length <= 1) return 0;
      const mean = calculateMean(values);
      const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
      const variance = calculateMean(squaredDiffs);
      return Math.sqrt(variance);
    }
    
    // 工具函数：模拟p值计算（简化版）
    function simulatePValue(control, variant) {
      // 实际应用中应使用适当的统计检验
      const effectSize = Math.abs(variant.mean - control.mean) / 
        Math.sqrt((Math.pow(control.std, 2) + Math.pow(variant.std, 2)) / 2);
      
      const sampleSize = Math.sqrt((control.n * variant.n) / (control.n + variant.n));
      const zScore = effectSize * sampleSize;
      
      // 从z分数近似p值（双尾检验）
      return 2 * (1 - normcdf(Math.abs(zScore)));
    }
    
    // 正态分布累积分布函数（近似）
    function normcdf(x) {
      const t = 1 / (1 + 0.2316419 * x);
      const d = 0.3989423 * Math.exp(-x * x / 2);
      const prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
      return x >= 0 ? 1 - prob : prob;
    }
    
    // 格式化数值显示
    function formatValue(value) {
      if (value >= 0 && value <= 1) {
        return (value * 100).toFixed(2) + '%';
      } else if (Math.abs(value) < 0.001 && value !== 0) {
        return value.toExponential(3);
      } else if (Math.abs(value) > 1000) {
        return value.toLocaleString();
      } else {
        return value.toFixed(2);
      }
    }
  </script>
</body>
</html>

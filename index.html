<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AB测试分析工具</title>
    <!-- 外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 样式配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563eb',
                        success: '#10b981',
                        warning: '#f59e0b',
                        danger: '#ef4444',
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .btn {
                @apply px-4 py-2 rounded-md font-medium transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2;
            }
            .btn-primary {
                @apply bg-primary text-white hover:bg-primary/90 focus:ring-primary/50;
            }
            .input-field {
                @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen p-4 md:p-6">
    <!-- 头部标题 -->
    <header class="mb-8 text-center">
        <h1 class="text-2xl md:text-3xl font-bold text-primary mb-2">AB测试分析工具</h1>
        <p class="text-gray-600">专注每日维度AB测试，自动分析置信结果与业务建议</p>
    </header>

    <main class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- 左侧：数据导入与参数配置 -->
        <div class="lg:col-span-1 space-y-6">
            <!-- 数据导入区域 -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-upload text-primary mr-2"></i>数据导入
                </h2>
                <!-- 数据格式提示 -->
                <div class="mb-4 p-3 bg-amber-50 rounded-md border border-amber-100">
                    <p class="text-sm text-amber-800 mb-1">
                        <i class="fa fa-exclamation-circle mr-1"></i>
                        <span class="text-red-600 font-medium">强制要求：</span>
                    </p>
                    <ul class="text-sm text-amber-800 list-disc list-inside pl-2 space-y-1">
                        <li>CSV文件必须包含“<span class="text-red-600 font-medium">分组列</span>”表头（区分对照组/测试组）</li>
                        <li>CSV文件必须包含“<span class="text-red-600 font-medium">时间</span>”表头（格式如2025-11-05）</li>
                        <li>其他列为数值型核心指标（如转化率、营收等）</li>
                    </ul>
                </div>
                <!-- 文件上传 -->
                <div id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-primary transition-all">
                    <i class="fa fa-file-text-o text-3xl text-gray-400 mb-2"></i>
                    <p class="text-gray-500">拖放CSV文件到此处，或</p>
                    <label class="mt-2 btn btn-primary inline-block cursor-pointer">
                        <span>选择文件</span>
                        <input type="file" id="fileInput" accept=".csv" class="hidden">
                    </label>
                    <p id="fileInfo" class="mt-2 text-sm text-gray-500"></p>
                </div>
            </div>

            <!-- 参数配置区域 -->
            <div id="configSection" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-cog text-primary mr-2"></i>分析配置
                </h2>
                <!-- 核心指标选择 -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        选择核心指标（可多选，将优先展示结果）
                    </label>
                    <div id="metricsContainer" class="space-y-2">
                        <!-- 核心指标选项将动态生成 -->
                    </div>
                </div>
                <!-- 置信水平 -->
                <div class="mb-4">
                    <label for="confidenceLevel" class="block text-sm font-medium text-gray-700 mb-2">
                        置信水平（默认95%）
                    </label>
                    <div class="flex items-center space-x-2">
                        <input type="range" id="confidenceLevel" min="90" max="99" value="95" step="1" class="w-full">
                        <span id="confidenceLevelValue" class="text-sm font-medium w-10 text-center">95%</span>
                    </div>
                </div>
                <!-- 异常值检测 -->
                <div class="mb-6">
                    <label class="flex items-center space-x-2 cursor-pointer">
                        <input type="checkbox" id="detectOutliers" class="rounded text-primary focus:ring-primary" checked>
                        <span class="text-sm text-gray-700">检测并排除异常值（推荐）</span>
                    </label>
                </div>
                <!-- 开始分析按钮 -->
                <button id="startABTestBtn" class="btn btn-primary w-full">
                    <i class="fa fa-play mr-1"></i>开始AB测试分析
                </button>
            </div>
        </div>

        <!-- 右侧：分析结果展示 -->
        <div class="lg:col-span-2 space-y-6">
            <!-- 核心指标结果（顶部优先展示） -->
            <div id="coreMetricsResult" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-lg font-semibold mb-4 flex items-center text-primary">
                    <i class="fa fa-star mr-2"></i>核心指标AB测试结果
                </h2>
                <div id="coreMetricsContent" class="space-y-6">
                    <!-- 核心指标结果将动态生成 -->
                </div>
            </div>

            <!-- 所有指标每日分析结果 -->
            <div id="dailyResult" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-lg font-semibold mb-4 flex items-center text-primary">
                    <i class="fa fa-calendar mr-2"></i>所有指标每日AB测试结果
                </h2>
                <div id="dailyResultContent" class="space-y-8">
                    <!-- 每日分析结果将动态生成 -->
                </div>
            </div>

            <!-- 业务建议 -->
            <div id="businessAdvice" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-lg font-semibold mb-4 flex items-center text-primary">
                    <i class="fa fa-lightbulb-o mr-2"></i>可视化业务建议
                </h2>
                <div id="adviceContent" class="p-4 rounded-md">
                    <!-- 业务建议将动态生成 -->
                </div>
            </div>

            <!-- 数据预览（可选） -->
            <div id="dataPreview" class="bg-white rounded-lg shadow p-6 hidden">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    <i class="fa fa-table text-primary mr-2"></i>数据预览（前5行）
                </h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead id="tableHeader" class="bg-gray-50"></thead>
                        <tbody id="tableBody" class="bg-white divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- 脚本 -->
    <script>
        // 全局变量
        let currentData = null; // 解析后的CSV数据
        let coreMetrics = [];   // 选中的核心指标
        let allMetrics = [];    // 所有数值型指标（除时间、分组列）

        // DOM元素
        const fileInput = document.getElementById('fileInput');
        const dropZone = document.getElementById('dropZone');
        const fileInfo = document.getElementById('fileInfo');
        const configSection = document.getElementById('configSection');
        const metricsContainer = document.getElementById('metricsContainer');
        const confidenceLevel = document.getElementById('confidenceLevel');
        const confidenceLevelValue = document.getElementById('confidenceLevelValue');
        const detectOutliers = document.getElementById('detectOutliers');
        const startABTestBtn = document.getElementById('startABTestBtn');
        const coreMetricsResult = document.getElementById('coreMetricsResult');
        const coreMetricsContent = document.getElementById('coreMetricsContent');
        const dailyResult = document.getElementById('dailyResult');
        const dailyResultContent = document.getElementById('dailyResultContent');
        const businessAdvice = document.getElementById('businessAdvice');
        const adviceContent = document.getElementById('adviceContent');
        const dataPreview = document.getElementById('dataPreview');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');

        // 初始化事件监听
        document.addEventListener('DOMContentLoaded', () => {
            // 文件上传监听
            fileInput.addEventListener('change', handleFileSelect);
            dropZone.addEventListener('drop', handleDrop);
            ['dragenter', 'dragover', 'dragleave'].forEach(event => {
                dropZone.addEventListener(event, preventDefaults);
            });
            ['dragenter', 'dragover'].forEach(event => {
                dropZone.addEventListener(event, highlight);
            });
            ['dragleave', 'drop'].forEach(event => {
                dropZone.addEventListener(event, unhighlight);
            });

            // 置信水平滑块监听
            confidenceLevel.addEventListener('input', () => {
                confidenceLevelValue.textContent = `${confidenceLevel.value}%`;
            });

            // 开始分析按钮监听
            startABTestBtn.addEventListener('click', startABTestAnalysis);
        });

        // 阻止默认拖放行为
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // 拖放高亮
        function highlight() {
            dropZone.classList.add('border-primary', 'bg-blue-50');
        }

        // 拖放取消高亮
        function unhighlight() {
            dropZone.classList.remove('border-primary', 'bg-blue-50');
        }

        // 处理文件拖放
        function handleDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) handleFiles(files);
        }

        // 处理文件选择
        function handleFileSelect(e) {
            const files = e.target.files;
            if (files.length > 0) handleFiles(files);
        }

        // 处理CSV文件
        function handleFiles(files) {
            const file = files[0];
            if (!file.name.endsWith('.csv')) {
                alert('请上传CSV格式文件！');
                return;
            }
            fileInfo.textContent = `已选择：${file.name}`;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvData = parseCSV(e.target.result);
                if (csvData) {
                    currentData = csvData;
                    validateDataStructure(); // 验证数据结构（必须含时间、分组列）
                }
            };
            reader.readAsText(file);
        }

        // 解析CSV数据
        function parseCSV(csvText) {
            try {
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                const headers = lines[0].split(',').map(header => header.trim());
                const data = [];

                lines.slice(1).forEach(line => {
                    const values = line.split(',').map(value => {
                        const trimmed = value.trim();
                        return isNaN(parseFloat(trimmed)) ? trimmed : parseFloat(trimmed);
                    });
                    const row = {};
                    headers.forEach((header, idx) => {
                        row[header] = values[idx] || '';
                    });
                    data.push(row);
                });
                return { headers, data };
            } catch (error) {
                alert('CSV文件解析失败，请检查格式！');
                return null;
            }
        }

        // 验证数据结构（强制含时间、分组列）
        function validateDataStructure() {
            const headers = currentData.headers.map(h => h.trim());
            const hasTimeColumn = headers.includes('时间');
            const hasGroupColumn = headers.includes('分组列');

            if (!hasTimeColumn || !hasGroupColumn) {
                alert(
                    `数据格式错误！\n` +
                    `必须包含以下表头：\n` +
                    `1. "时间"（时间维度，如2025-11-05）\n` +
                    `2. "分组列"（分组标识，如Control/Test）`
                );
                return;
            }

            // 提取所有数值型指标（除时间、分组列）
            allMetrics = headers.filter(header => {
                if (header === '时间' || header === '分组列') return false;
                // 验证列是否为数值型（检查前10行数据）
                const sampleValues = currentData.data.slice(0, 10).map(row => row[header]);
                return sampleValues.every(v => typeof v === 'number' && !isNaN(v));
            });

            if (allMetrics.length === 0) {
                alert('未找到数值型指标列！除"时间"和"分组列"外，需至少1列数值数据（如转化率、营收）');
                return;
            }

            // 生成核心指标选择框
            renderMetricsSelector();
            // 显示配置区域和数据预览
            configSection.classList.remove('hidden');
            renderDataPreview();
            dataPreview.classList.remove('hidden');
        }

        // 生成核心指标选择框
        function renderMetricsSelector() {
            metricsContainer.innerHTML = '';
            allMetrics.forEach(metric => {
                const div = document.createElement('div');
                div.className = 'flex items-center space-x-2';
                div.innerHTML = `
                    <input type="checkbox" id="metric_${metric}" value="${metric}" class="rounded text-primary focus:ring-primary" checked>
                    <label for="metric_${metric}" class="text-sm text-gray-700 cursor-pointer">${metric}</label>
                `;
                metricsContainer.appendChild(div);
            });
        }

        // 渲染数据预览
        function renderDataPreview() {
            // 生成表头
            tableHeader.innerHTML = '';
            const headerRow = document.createElement('tr');
            currentData.headers.forEach(header => {
                const th = document.createElement('th');
                th.className = 'px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase';
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHeader.appendChild(headerRow);

            // 生成表体（前5行）
            tableBody.innerHTML = '';
            currentData.data.slice(0, 5).forEach(row => {
                const tr = document.createElement('tr');
                currentData.headers.forEach(header => {
                    const td = document.createElement('td');
                    td.className = 'px-4 py-2 whitespace-nowrap text-sm text-gray-700';
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
        }

        // 开始AB测试分析
        function startABTestAnalysis() {
            // 获取选中的核心指标
            coreMetrics = Array.from(document.querySelectorAll('#metricsContainer input:checked'))
                .map(cb => cb.value);
            if (coreMetrics.length === 0) {
                alert('请至少选择1个核心指标！');
                return;
            }

            // 获取分析参数
            const confidenceLevelVal = parseInt(confidenceLevel.value);
            const excludeOutliers = detectOutliers.checked;

            // 按时间+分组分组数据
            const groupedData
